<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Lentes Intraoculares (IOL)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        
        /* Estilos del Encabezado */
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
        .header-left { display: flex; align-items: center; justify-content: center; gap: 20px; text-align: center; flex: 1; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        
        .header h1 { margin: 0; color: #2c3e50; font-size: 2em; }
        .header p { margin: 5px 0 0 0; color: #666; font-size: 1em; }
        .logo-img { height: 80px; width: auto; object-fit: contain; }

        /* SWITCH MODO COMPARAR */
        .compare-switch-container { display: flex; align-items: center; gap: 10px; font-size: 0.9em; font-weight: 600; background: #f8f9fa; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #007bff; }
        input:checked + .slider:before { transform: translateX(18px); }

        /* BOTÓN FLOTANTE COMPARAR */
        #btn-ver-comparacion {
            position: fixed; bottom: 30px; right: 30px;
            background-color: #28a745; color: white;
            padding: 15px 25px; border-radius: 50px;
            font-weight: bold; font-size: 1.1em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer; z-index: 1500;
            display: none; border: none; transition: transform 0.2s;
        }
        #btn-ver-comparacion:hover { transform: scale(1.05); background-color: #218838; }

        /* Estilos de Filtros */
        .filtros { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 20px; background: #eef2f7; border-radius: 8px; border-left: 5px solid #007bff; }
        .filtro-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9em; color: #555; }
        .filtro-group select, .filtro-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        
        /* Estilo del Contador */
        .contador-container { text-align: center; margin-bottom: 20px; }
        .contador-badge { display: inline-block; background-color: #007bff; color: white; padding: 8px 20px; border-radius: 50px; font-weight: bold; font-size: 1.1em; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Tabla de Resultados */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95em; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #007bff; color: white; white-space: nowrap; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* ESTILOS FILA SELECCIONADA */
        tr.selected-row { background-color: #e3f2fd !important; border-left: 5px solid #007bff; }
        tr { cursor: pointer; transition: background-color 0.2s; }
        tr:hover { background-color: #e3f2fd; }
        
        /* Etiquetas dentro de la tabla */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .badge-torico { background-color: #ffeb3b; color: #333; }
        .badge-no-torico { background-color: #e0e0e0; color: #555; }
        .badge-mono { background-color: #d1e7dd; color: #0f5132; }
        .badge-multi { background-color: #f8d7da; color: #842029; }
        
        /* --- ESTILOS DEL POPUP --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal-content {
            background: white; width: 95%; max-width: 1400px; max-height: 90vh;
            border-radius: 10px; padding: 30px; overflow-y: auto;
            position: relative; box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
        }
        .close-btn {
            position: absolute; top: 15px; right: 20px;
            font-size: 28px; cursor: pointer; color: #999; font-weight: bold; z-index: 10;
        }
        .close-btn:hover { color: #333; }
        
        /* GRID COMPARACIÓN AMPLIO */
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            align-items: start; /* Para que las tarjetas no se estiren */
        }
        .lente-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: 100%; /* Todas las tarjetas igual de alto */
            display: flex;
            flex-direction: column;
        }
        .lente-card h4 { 
            margin-top: 0; 
            color: #007bff; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px; 
            font-size: 1.1em;
            text-align: center;
        }

        .card-section { margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .card-section:last-child { border-bottom: none; }
        .card-title { font-size: 0.85em; text-transform: uppercase; color: #888; font-weight: bold; margin-bottom: 8px; letter-spacing: 0.5px; }

        .detail-item { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9em; }
        .detail-label { font-weight: 600; color: #555; }
        .detail-value { text-align: right; font-weight: 500; color: #222; }

        /* Etiqueta para tipo de constante */
        .const-type-badge { 
            font-size: 0.7em; 
            padding: 2px 5px; 
            border-radius: 4px; 
            margin-left: 5px; 
            font-weight: normal;
            vertical-align: middle;
        }
        .type-opt { background-color: #d1e7dd; color: #0f5132; } /* Verde para Optimizada */
        .type-nom { background-color: #fff3cd; color: #664d03; } /* Amarillo para Nominal */
        .type-ulib { background-color: #e2e3e5; color: #41464b; } /* Gris para ULIB */
        
        .highlight-val { color: #d63384; font-weight: bold; } /* Rosa para A-Const */

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .hidden { display: none !important; }
        .login-box { padding: 40px; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); text-align: center; }
    </style>
</head>
<body>

    <!-- PANTALLA DE ACCESO -->
    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:#007bff; margin-bottom: 10px;">Acceso a Catálogo IOL</h2>
            <p>Introduzca la contraseña autorizada:</p>
            <input type="password" id="password-input" placeholder="Contraseña" style="padding:10px; width: 200px; margin-bottom: 10px;">
            <br>
            <button onclick="checkPassword()" style="padding: 10px 25px; background:#007bff; color:white; border:none; border-radius:5px; cursor:pointer;">Entrar</button>
            <p id="error-msg" style="color: red; display: none; margin-top:10px;">Contraseña incorrecta</p>
        </div>
    </div>

    <!-- BOTÓN FLOTANTE PARA COMPARAR -->
    <button id="btn-ver-comparacion" onclick="abrirComparacion()">
        Ver Comparación (<span id="num-seleccionados">0</span>)
    </button>

    <!-- APLICACIÓN PRINCIPAL -->
    <div id="app" class="container hidden">
        
        <!-- HEADER CON LOGO Y SWITCH -->
        <div class="header">
            <div class="header-left">
                <img src="logo.png" alt="Logo Institucional" class="logo-img">
                <div>
                    <h1>Catálogo de Lentes</h1>
                    <p>Haz clic en una lente para ver detalles</p>
                </div>
            </div>
            
            <div class="header-right">
                <div class="compare-switch-container" title="Activa para seleccionar varios lentes y compararlos">
                    <span>Modo Comparar</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-compare" onchange="toggleModoComparar()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="filtros">
            <div class="filtro-group">
                <label>Fabricante</label>
                <select id="filtro-fabricante" onchange="filtrarLentes()">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filtro-group">
                <label>Modelo (Nombre)</label>
                <input type="text" id="filtro-modelo" placeholder="Ej: 611HPS..." onkeyup="filtrarLentes()">
            </div>
            <div class="filtro-group">
                <label>Tórico</label>
                <select id="filtro-torico" onchange="filtrarLentes()">
                    <option value="">Todos</option>
                    <option value="yes">Sí (Tórico)</option>
                    <option value="no">No (Esférico)</option>
                </select>
            </div>
            <div class="filtro-group">
                <label>Concepto Óptico</label>
                <select id="filtro-concepto" onchange="filtrarLentes()">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filtro-group">
                <label>Diseño Óptico</label>
                <select id="filtro-diseno" onchange="filtrarLentes()">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filtro-group">
                <label>Rango Potencia (D)</label>
                <input type="number" id="filtro-potencia" placeholder="Buscar valor..." onkeyup="filtrarLentes()">
            </div>
        </div>

        <!-- ETIQUETA CONTADOR -->
        <div class="contador-container">
            <span id="contador-resultados" class="contador-badge">Mostrando 0 lentes</span>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fabricante</th>
                        <th>Modelo</th>
                        <th>Tórico</th>
                        <th>Concepto</th>
                        <th>Diseño</th>
                        <th>Rango Potencia (D)</th>
                        <th>Material</th>
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    <!-- Los datos se cargarán aquí -->
                </tbody>
            </table>
        </div>
        <p style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em;">Fuente: IOLexport.xml (GitHub) - Actualización automática</p>
    </div>

    <!-- POPUP / MODAL DE DETALLES -->
    <div id="detalle-popup" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarPopup()">&times;</span>
            <h2 id="modal-title" style="color:#2c3e50; margin-top:0; text-align:center;">Detalle del Lente</h2>
            
            <div id="modal-body">
                <!-- El contenido se generará dinámicamente con JS -->
            </div>
        </div>
    </div>

    <script>
        let datosLentes = [];
        let idsSeleccionados = [];
        let esModoComparar = false;
        const CLAVE_ACCESO = "medicos2024"; // RECUERDA CAMBIAR ESTO

        function checkPassword() {
            const input = document.getElementById('password-input').value;
            if (input === CLAVE_ACCESO) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                cargarDatos();
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        function cargarDatos() {
            const url = 'https://raw.githubusercontent.com/globalatsdr/IOLs-Database/main/IOLexport.xml';
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error("Error al conectar con GitHub.");
                    return response.text();
                })
                .then(str => {
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(str, "text/xml");
                    const lentes = xml.getElementsByTagName("Lens");

                    datosLentes = Array.from(lentes).map(lente => {
                        const id = lente.getAttribute("id") || "N/A";
                        const fabricante = getSafeText(lente, "Manufacturer");
                        const modelo = getSafeText(lente, "Name");
                        
                        const specs = lente.getElementsByTagName("Specifications")[0];
                        const specsData = {
                            torico: getSafeText(specs, "Toric").toLowerCase(),
                            material: getSafeText(specs, "OpticMaterial"),
                            concepto: getSafeText(specs, "OpticConcept"),
                            diseno: getSafeText(specs, "OpticDesign"),
                            piezaUnica: getSafeText(specs, "SinglePiece"),
                            materialHaptico: getSafeText(specs, "HapticMaterial"),
                            precargado: getSafeText(specs, "Preloaded"),
                            plegable: getSafeText(specs, "Foldable"),
                            incision: getSafeText(specs, "IncisionWidth"),
                            inyector: getSafeText(specs, "InjectorSize"),
                            hidro: getSafeText(specs, "Hydro"),
                            filtro: getSafeText(specs, "Filter"),
                            indiceRefraccion: getSafeText(specs, "RefractiveIndex"),
                            numeroAbbe: getSafeText(specs, "AbbeNumber"),
                            diametroOptico: getSafeText(specs, "OpticDiameter"),
                            diametroTotal: getSafeText(specs, "HapticDiameter"),
                            disenoHaptico: getSafeText(specs, "HapticDesign"),
                            ubicacion: getSafeText(specs, "IntendedLocation"),
                            aberracion: getSafeText(specs, "Aberration"),
                            saCorrection: getSafeText(specs, "saCorrection")
                        };

                        // --- GUARDAR TODAS LAS CONSTANTES (Optimizadas, Nominales, ULIB) ---
                        const constantsList = lente.getElementsByTagName("Constants");
                        const allConstants = { optimized: {}, nominal: {}, ulib: {} };

                        Array.from(constantsList).forEach(c => {
                            const type = c.getAttribute("type"); // "optimized", "nominal", etc.
                            
                            // Extraer Haigis
                            const haigisNode = c.getElementsByTagName("Haigis")[0];
                            const haigis = haigisNode ? {
                                a0: getSafeText(haigisNode, "a0"),
                                a1: getSafeText(haigisNode, "a1"),
                                a2: getSafeText(haigisNode, "a2")
                            } : {};

                            // Extraer Barrett
                            const barrettNode = c.getElementsByTagName("Barrett")[0];
                            const barrett = barrettNode ? {
                                LF: getSafeText(barrettNode, "LF"),
                                DF: getSafeText(barrettNode, "DF")
                            } : {};

                            // Guardar en el bucket correspondiente
                            if(allConstants[type] !== undefined) {
                                allConstants[type] = {
                                    ultrasound: getSafeText(c, "Ultrasound"),
                                    srkt: getSafeText(c, "SRKt"),
                                    haigis: haigis,
                                    hofferQ: getSafeText(c, "HofferQ"),
                                    holladay1: getSafeText(c, "Holladay1"),
                                    barrett: barrett
                                };
                            }
                        });

                        const availability = lente.getElementsByTagName("Availability")[0];
                        const sphereRanges = availability.getElementsByTagName("Sphere");
                        
                        let minPower = Infinity;
                        let maxPower = -Infinity;
                        let rangesText = [];

                        Array.from(sphereRanges).forEach(r => {
                            const from = parseFloat(getSafeText(r, "From"));
                            const to = parseFloat(getSafeText(r, "To"));
                            const inc = getSafeText(r, "Increment");
                            if (!isNaN(from) && from < minPower) minPower = from;
                            if (!isNaN(to) && to > maxPower) maxPower = to;
                            if(!isNaN(from) && !isNaN(to)) {
                                rangesText.push(`De ${from} a ${to} (inc: ${inc})`);
                            }
                        });

                        const cylRanges = availability.getElementsByTagName("Cylinder");
                        let cylText = [];
                        Array.from(cylRanges).forEach(c => {
                             const from = getSafeText(c, "From");
                             const to = getSafeText(c, "To");
                             const inc = getSafeText(c, "Increment");
                             cylText.push(`${from} a ${to} (inc: ${inc})`);
                        });

                        let rangoTexto = "N/A";
                        if (minPower !== Infinity && maxPower !== -Infinity) {
                            rangoTexto = `${minPower} a ${maxPower}`;
                        }

                        return {
                            id: id,
                            fabricante: fabricante,
                            modelo: modelo,
                            torico: specsData.torico,
                            concepto: specsData.concepto,
                            diseno: specsData.diseno,
                            rango_min: minPower === Infinity ? 0 : minPower,
                            rango_max: maxPower === -Infinity ? 0 : maxPower,
                            rango_texto: rangoTexto,
                            material: specsData.material,
                            detalles: {
                                specs: specsData,
                                constants: allConstants, // Guardamos los 3 tipos
                                availability: { sphere: rangesText, cylinder: cylText }
                            }
                        };
                    });

                    poblarFiltrosDinamicos();
                    filtrarLentes();
                })
                .catch(error => {
                    console.error(error);
                    document.getElementById('tabla-body').innerHTML = `<tr><td colspan='8' style='text-align:center; color:red;'>${error.message}</td></tr>`;
                });
        }

        function getSafeText(parent, tagName) {
            const element = parent.getElementsByTagName(tagName)[0];
            return element ? element.textContent.trim() : "";
        }

        // --- FUNCIÓN CLAVE: OBTENER LA MEJOR CONSTANTE ---
        function getBestConstant(lente, key) {
            const c = lente.detalles.constants;
            let val = null;
            let type = "";

            // 1. Prioridad: Optimizada
            if (c.optimized && c.optimized[key] && c.optimized[key].trim() !== "") {
                val = c.optimized[key];
                type = "Opt";
            } 
            // 2. Prioridad: Nominal
            else if (c.nominal && c.nominal[key] && c.nominal[key].trim() !== "") {
                val = c.nominal[key];
                type = "Nom";
            }
            // 3. Prioridad: ULIB
            else if (c.ulib && c.ulib[key] && c.ulib[key].trim() !== "") {
                val = c.ulib[key];
                type = "ULIB";
            }

            return { value: val || "N/A", type: type };
        }

        // --- FUNCIÓN PARA HAIGIS (Objeto anidado) ---
        function getBestHaigis(lente) {
            const c = lente.detalles.constants;
            // Verificamos si hay al menos un dato en Optimizada
            const optValid = c.optimized.haigis && (c.optimized.haigis.a0 || c.optimized.haigis.a1 || c.optimized.haigis.a2);
            
            if (optValid) return { data: c.optimized.haigis, type: "Opt" };
            if (c.nominal.haigis && (c.nominal.haigis.a0 || c.nominal.haigis.a1 || c.nominal.haigis.a2)) return { data: c.nominal.haigis, type: "Nom" };
            if (c.ulib.haigis && (c.ulib.haigis.a0 || c.ulib.haigis.a1 || c.ulib.haigis.a2)) return { data: c.ulib.haigis, type: "ULIB" };
            return { data: { a0: "N/A", a1: "N/A", a2: "N/A" }, type: "" };
        }

        function poblarFiltrosDinamicos() {
            const llenarSelect = (id, datos) => {
                const select = document.getElementById(id);
                while (select.options.length > 1) { select.remove(1); }
                const valoresUnicos = [...new Set(datos)].sort();
                valoresUnicos.forEach(val => {
                    if(val) {
                        const option = document.createElement('option');
                        option.value = val;
                        option.textContent = val.charAt(0).toUpperCase() + val.slice(1);
                        select.appendChild(option);
                    }
                });
            };

            llenarSelect('filtro-fabricante', datosLentes.map(l => l.fabricante));
            llenarSelect('filtro-concepto', datosLentes.map(l => l.concepto));
            llenarSelect('filtro-diseno', datosLentes.map(l => l.diseno));
        }

        function toggleModoComparar() {
            esModoComparar = document.getElementById('toggle-compare').checked;
            if(!esModoComparar) {
                idsSeleccionados = [];
                actualizarBotonComparacion();
                document.querySelectorAll('.selected-row').forEach(row => row.classList.remove('selected-row'));
            }
        }

        function manejarClickFila(id, rowElement) {
            if (esModoComparar) {
                const index = idsSeleccionados.indexOf(id);
                if (index > -1) {
                    idsSeleccionados.splice(index, 1);
                    rowElement.classList.remove('selected-row');
                } else {
                    idsSeleccionados.push(id);
                    rowElement.classList.add('selected-row');
                }
                actualizarBotonComparacion();
            } else {
                abrirPopup(id);
            }
        }

        function actualizarBotonComparacion() {
            const btn = document.getElementById('btn-ver-comparacion');
            const numSpan = document.getElementById('num-seleccionados');
            numSpan.textContent = idsSeleccionados.length;
            if (esModoComparar && idsSeleccionados.length >= 2) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        }

        function abrirComparacion() {
            const lentesComparar = datosLentes.filter(l => idsSeleccionados.includes(l.id));
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');

            modalTitle.textContent = "Comparación de Lentes";
            
            let html = '<div class="comparison-grid">';
            
            lentesComparar.forEach(l => {
                const d = l.detalles.specs;
                
                // Obtener mejores constantes
                const aConst = getBestConstant(l, 'ultrasound');
                const srkt = getBestConstant(l, 'srkt');
                const hofferQ = getBestConstant(l, 'hofferQ');
                const holladay1 = getBestConstant(l, 'holladay1');
                const haigis = getBestHaigis(l);
                const barrett = getBestConstant(l, 'barrett'); // Barrett puede ser complejo, simplificamos

                // Función auxiliar para badge de tipo
                const getTypeBadge = (type) => {
                    if(!type) return '';
                    let cls = type === 'Opt' ? 'type-opt' : (type === 'Nom' ? 'type-nom' : 'type-ulib');
                    return `<span class="const-type-badge ${cls}">${type}</span>`;
                };

                html += `
                <div class="lente-card">
                    <h4>${l.fabricante} <br><small>${l.modelo}</small></h4>
                    
                    <div class="card-section">
                        <div class="card-title">Especificaciones</div>
                        <div class="detail-item"><span class="detail-label">ID:</span> <span class="detail-value">${l.id}</span></div>
                        <div class="detail-item"><span class="detail-label">Material:</span> <span class="detail-value">${d.material}</span></div>
                        <div class="detail-item"><span class="detail-label">Concepto:</span> <span class="detail-value">${d.concepto}</span></div>
                        <div class="detail-item"><span class="detail-label">Tórico:</span> <span class="detail-value">${d.torico === 'yes' ? 'Sí' : 'No'}</span></div>
                        <div class="detail-item"><span class="detail-label">Plegable:</span> <span class="detail-value">${d.plegable}</span></div>
                        <div class="detail-item"><span class="detail-label">Incisión:</span> <span class="detail-value">${d.incision} mm</span></div>
                        <div class="detail-item"><span class="detail-label">Índice Refr.:</span> <span class="detail-value">${d.indiceRefraccion}</span></div>
                        <div class="detail-item"><span class="detail-label">Nº Abbe:</span> <span class="detail-value">${d.numeroAbbe}</span></div>
                    </div>

                    <div class="card-section">
                        <div class="card-title">Dimensiones</div>
                        <div class="detail-item"><span class="detail-label">Dia. Óptico:</span> <span class="detail-value">${d.diametroOptico} mm</span></div>
                        <div class="detail-item"><span class="detail-label">Dia. Total:</span> <span class="detail-value">${d.diametroTotal} mm</span></div>
                        <div class="detail-item"><span class="detail-label">Háptico:</span> <span class="detail-value">${d.disenoHaptico}</span></div>
                        <div class="detail-item"><span class="detail-label">Ubicación:</span> <span class="detail-value">${d.ubicacion}</span></div>
                    </div>

                    <div class="card-section">
                        <div class="card-title">Constantes</div>
                        <div class="detail-item" style="font-size:1.1em;">
                            <span class="detail-label">A-Const:</span> 
                            <span class="detail-value highlight-val">${aConst.value} ${getTypeBadge(aConst.type)}</span>
                        </div>
                        <div class="detail-item"><span class="detail-label">SRK/T:</span> <span class="detail-value">${srkt.value} ${getTypeBadge(srkt.type)}</span></div>
                        <div class="detail-item"><span class="detail-label">Hoffer Q:</span> <span class="detail-value">${hofferQ.value} ${getTypeBadge(hofferQ.type)}</span></div>
                        <div class="detail-item"><span class="detail-label">Holladay 1:</span> <span class="detail-value">${holladay1.value} ${getTypeBadge(holladay1.type)}</span></div>
                        
                        ${haigis.type ? `
                        <div style="background:#f8f9fa; padding:8px; border-radius:4px; margin-top:5px;">
                            <div style="font-size:0.8em; color:#666; margin-bottom:4px;">Haigis ${getTypeBadge(haigis.type)}</div>
                            <div class="detail-item"><span class="detail-label">a0:</span> <span class="detail-value">${haigis.data.a0}</span></div>
                            <div class="detail-item"><span class="detail-label">a1:</span> <span class="detail-value">${haigis.data.a1}</span></div>
                            <div class="detail-item"><span class="detail-label">a2:</span> <span class="detail-value">${haigis.data.a2}</span></div>
                        </div>` : ''}

                        <div class="detail-item" style="margin-top:5px;"><span class="detail-label">Barrett LF:</span> <span class="detail-value">${barrett.value.LF || 'N/A'}</span></div>
                    </div>
                    
                    <div class="card-section">
                        <div class="card-title">Disponibilidad</div>
                        <div style="font-size:0.85em; color:#555;">
                            <strong>Esfera:</strong> ${l.detalles.availability.sphere.join(' | ')}<br>
                            ${l.detalles.availability.cylinder.length > 0 ? `<strong>Cilindro:</strong> ${l.detalles.availability.cylinder.join(' | ')}` : ''}
                        </div>
                    </div>
                </div>
                `;
            });
            
            html += '</div>';
            modalBody.innerHTML = html;
            document.getElementById('detalle-popup').classList.add('active');
        }

        function filtrarLentes() {
            const fFab = document.getElementById('filtro-fabricante').value;
            const fMod = document.getElementById('filtro-modelo').value.toLowerCase();
            const fTor = document.getElementById('filtro-torico').value;
            const fCon = document.getElementById('filtro-concepto').value;
            const fDis = document.getElementById('filtro-diseno').value;
            const fPot = parseFloat(document.getElementById('filtro-potencia').value) || 0;

            const tbody = document.getElementById('tabla-body');
            tbody.innerHTML = "";

            const filtrados = datosLentes.filter(l => {
                const matchFab = fFab === "" || l.fabricante === fFab;
                const matchMod = l.modelo.toLowerCase().includes(fMod);
                const matchTor = fTor === "" || l.torico === fTor;
                const matchCon = fCon === "" || l.concepto === fCon;
                const matchDis = fDis === "" || l.diseno === fDis;
                const matchPot = fPot === 0 || (l.rango_min <= fPot && l.rango_max >= fPot);
                return matchFab && matchMod && matchTor && matchCon && matchDis && matchPot;
            });

            document.getElementById('contador-resultados').textContent = `Mostrando ${filtrados.length} lentes`;

            if (filtrados.length === 0) {
                tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>No se encontraron lentes con estos criterios.</td></tr>";
                return;
            }

            filtrados.forEach(l => {
                const badgeTorico = l.torico === 'yes' ? 'badge-torico' : 'badge-no-torico';
                const textoTorico = l.torico === 'yes' ? 'Sí' : 'No';
                const badgeConcepto = l.concepto.includes('multi') ? 'badge-multi' : 'badge-mono';
                const rowId = `row-${l.id}`;

                const row = `<tr id="${rowId}" onclick="manejarClickFila('${l.id}', this)" title="${esModoComparar ? 'Clic para seleccionar' : 'Clic para ver detalles'}">
                    <td><small>${l.id}</small></td>
                    <td><strong>${l.fabricante}</strong></td>
                    <td>${l.modelo}</td>
                    <td><span class="badge ${badgeTorico}">${textoTorico}</span></td>
                    <td><span class="badge ${badgeConcepto}">${l.concepto}</span></td>
                    <td>${l.diseno}</td>
                    <td>${l.rango_texto}</td>
                    <td>${l.material}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function abrirPopup(id) {
            const lente = datosLentes.find(l => l.id === id);
            if(!lente) return;

            const d = lente.detalles.specs;
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');

            modalTitle.textContent = `${lente.fabricante} - ${lente.modelo}`;

            // Usamos las mismas funciones de "Mejor Constante" para la vista individual también
            const aConst = getBestConstant(lente, 'ultrasound');
            const srkt = getBestConstant(lente, 'srkt');
            const hofferQ = getBestConstant(lente, 'hofferQ');
            const holladay1 = getBestConstant(lente, 'holladay1');
            const haigis = getBestHaigis(lente);

            const getTypeBadge = (type) => {
                if(!type) return '';
                let cls = type === 'Opt' ? 'type-opt' : (type === 'Nom' ? 'type-nom' : 'type-ulib');
                return `<span class="const-type-badge ${cls}">${type}</span>`;
            };

            let html = `
                <div class="detail-section">
                    <h3>Información General</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="detail-label">ID:</span> <span class="detail-value">${lente.id}</span></div>
                        <div class="detail-item"><span class="detail-label">Tórico:</span> <span class="detail-value">${d.torico === 'yes' ? 'Sí' : 'No'}</span></div>
                        <div class="detail-item"><span class="detail-label">Material:</span> <span class="detail-value">${d.material}</span></div>
                        <div class="detail-item"><span class="detail-label">Plegable:</span> <span class="detail-value">${d.plegable}</span></div>
                        <div class="detail-item"><span class="detail-label">Incisión (mm):</span> <span class="detail-value">${d.incision}</span></div>
                        <div class="detail-item"><span class="detail-label">Índice Refracción:</span> <span class="detail-value">${d.indiceRefraccion}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Diseño y Dimensiones</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="detail-label">Concepto:</span> <span class="detail-value">${d.concepto}</span></div>
                        <div class="detail-item"><span class="detail-label">Diseño Óptico:</span> <span class="detail-value">${d.diseno}</span></div>
                        <div class="detail-item"><span class="detail-label">Diámetro Óptico:</span> <span class="detail-value">${d.diametroOptico}</span></div>
                        <div class="detail-item"><span class="detail-label">Diámetro Total:</span> <span class="detail-value">${d.diametroTotal}</span></div>
                        <div class="detail-item"><span class="detail-label">Diseño Háptico:</span> <span class="detail-value">${d.disenoHaptico}</span></div>
                        <div class="detail-item"><span class="detail-label">Ubicación:</span> <span class="detail-value">${d.ubicacion}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Constantes (Mejor Disponible)</h3>
                    <div class="detail-grid">
                        <div class="detail-item" style="color:#007bff; font-weight:bold;">
                            <span class="detail-label">A-Const (US):</span> 
                            <span class="detail-value">${aConst.value} ${getTypeBadge(aConst.type)}</span>
                        </div>
                        <div class="detail-item"><span class="detail-label">SRK/T:</span> <span class="detail-value">${srkt.value} ${getTypeBadge(srkt.type)}</span></div>
                        <div class="detail-item"><span class="detail-label">Hoffer Q:</span> <span class="detail-value">${hofferQ.value} ${getTypeBadge(hofferQ.type)}</span></div>
                        <div class="detail-item"><span class="detail-label">Holladay 1:</span> <span class="detail-value">${holladay1.value} ${getTypeBadge(holladay1.type)}</span></div>
                    </div>
                    ${haigis.type ? `
                    <div class="detail-grid" style="margin-top:10px; background:#f9f9f9; padding:10px; border-radius:5px;">
                         <div style="grid-column: span 2; font-weight:bold; color:#555; margin-bottom:5px;">Haigis ${getTypeBadge(haigis.type)}</div>
                         <div class="detail-item"><span class="detail-label">Haigis a0:</span> <span class="detail-value">${haigis.data.a0}</span></div>
                         <div class="detail-item"><span class="detail-label">Haigis a1:</span> <span class="detail-value">${haigis.data.a1}</span></div>
                         <div class="detail-item"><span class="detail-label">Haigis a2:</span> <span class="detail-value">${haigis.data.a2}</span></div>
                    </div>` : ''}
                </div>

                <div class="detail-section">
                    <h3>Disponibilidad</h3>
                    <p><strong>Esfera:</strong> ${lente.detalles.availability.sphere.length > 0 ? lente.detalles.availability.sphere.join(' | ') : 'N/A'}</p>
                    <p><strong>Cilindro:</strong> ${lente.detalles.availability.cylinder.length > 0 ? lente.detalles.availability.cylinder.join(' | ') : 'No es tórico o sin datos'}</p>
                </div>
            `;

            modalBody.innerHTML = html;
            document.getElementById('detalle-popup').classList.add('active');
        }

        function cerrarPopup() {
            document.getElementById('detalle-popup').classList.remove('active');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('detalle-popup');
            if (event.target == modal) {
                cerrarPopup();
            }
        }
    </script>
</body>
</html>
